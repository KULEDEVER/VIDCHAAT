<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Video Call (SimplePeer)</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 20px; }
  video { width: 45%; border: 1px solid #ccc; margin: 10px; }
  button { margin: 5px; padding: 10px; font-size: 16px; }
</style>
<link rel="icon" href="data:,">
</head>
<body>
<h1>Private Video Call App</h1>

<div>
  <video id="cam1" autoplay playsinline muted></video>
  <video id="cam2" autoplay playsinline></video>
</div>

<br>
<button id="hostCall">HOST CALL</button>
<button id="joinCall">JOIN CALL</button>

<div id="consentDiv" style="display:none;">
  <p id="consentText"></p>
  <button id="yesBtn">Yes</button>
  <button id="noBtn">No</button>
</div>

<button id="endCall">End Call</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
import SimplePeer from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBfjR8mMsw6M0OzpllGbtZrPPVzZwu_-4",
  authDomain: "picdbdb.firebaseapp.com",
  databaseURL: "https://picdbdb-default-rtdb.firebaseio.com",
  projectId: "picdbdb",
  storageBucket: "picdbdb.firebasestorage.app",
  messagingSenderId: "1090760779582",
  appId: "1:1090760779582:web:8cd9355bcba80de60e6e6f",
  measurementId: "G-Q6N1B7H0KJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const localVideo = document.getElementById('cam1');
const remoteVideo = document.getElementById('cam2');
const consentDiv = document.getElementById('consentDiv');
const consentText = document.getElementById('consentText');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const endBtn = document.getElementById('endCall');

let localStream;
let peer;
let role = null; // "host" or "joiner"

// Firebase paths
const requestsRef = ref(db, 'privateCall/joinRequests');
const signalRef = ref(db, 'privateCall/signal');

// ---------- Helpers ----------
async function startLocalStream() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;
}

function cleanup() {
  if(peer) peer.destroy();
  if(localStream) localStream.getTracks().forEach(t => t.stop());
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  remove(ref(db, 'privateCall'));
}

// ---------- HOST ----------
document.getElementById('hostCall').onclick = async () => {
  role = "host";
  await startLocalStream();

  // Listen for join requests
  onValue(requestsRef, snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const joinerId = Object.keys(data)[0]; // one request at a time
    consentText.textContent = "Someone wants to join your call. Do you consent?";
    consentDiv.style.display = "block";

    yesBtn.onclick = () => {
      set(ref(db, `privateCall/joinRequests/${joinerId}/consent`), "yes");
      consentDiv.style.display = "none";
      startPeer(true); // host initiates SimplePeer
    };

    noBtn.onclick = () => {
      set(ref(db, `privateCall/joinRequests/${joinerId}/consent`), "no");
      consentDiv.style.display = "none";
    };
  });
};

// ---------- JOINER ----------
document.getElementById('joinCall').onclick = async () => {
  role = "joiner";
  await startLocalStream();

  const myReqRef = push(requestsRef);
  await set(myReqRef, { consent: "pending" });

  onValue(myReqRef, snapshot => {
    const data = snapshot.val();
    if(!data) return;
    if(data.consent === "no") alert("Host denied your request.");
    if(data.consent === "yes") startPeer(false); // joiner waits for signal
  });
};

// ---------- SimplePeer Setup ----------
function startPeer(initiator) {
  peer = new SimplePeer({ initiator, stream: localStream, trickle: true });

  peer.on('signal', data => {
    const key = push(signalRef);
    set(key, JSON.stringify({ role, data }));
  });

  peer.on('stream', stream => {
    remoteVideo.srcObject = stream;
  });

  // Listen for signals from Firebase
  onValue(signalRef, snapshot => {
    const signals = snapshot.val();
    if (!signals) return;
    Object.values(signals).forEach(s => {
      if(s.role !== role) peer.signal(s.data);
    });
  });
}

// ---------- END CALL ----------
endBtn.onclick = () => {
  cleanup();
  alert('Call ended');
};
</script>
</body>
</html>

