<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Video Call</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 20px; }
  video { width: 45%; border: 1px solid #ccc; margin: 10px; }
  button { margin: 5px; padding: 10px; font-size: 16px; }
</style>
<link rel="icon" href="data:,">
</head>
<body>
<h1>Private Video Call App</h1>

<div>
  <video id="cam1" autoplay playsinline muted></video>
  <video id="cam2" autoplay playsinline></video>
</div>

<br>
<button id="hostCall">HOST CALL</button>
<button id="joinCall">JOIN CALL</button>

<div id="consentDiv" style="display:none;">
  <p id="consentText"></p>
  <button id="yesBtn">Yes</button>
  <button id="noBtn">No</button>
</div>

<button id="endCall">End Call</button>

<!-- Firebase UMD (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- SimplePeer UMD -->
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

<script>
  // ===== Firebase Setup =====
  const firebaseConfig = {
    apiKey: "AIzaSyCBfjR8mMsw6M0OzpllGbtZrPPVzZwu_-4",
    authDomain: "picdbdb.firebaseapp.com",
    databaseURL: "https://picdbdb-default-rtdb.firebaseio.com",
    projectId: "picdbdb",
    storageBucket: "picdbdb.firebasestorage.app",
    messagingSenderId: "1090760779582",
    appId: "1:1090760779582:web:8cd9355bcba80de60e6e6f",
    measurementId: "G-Q6N1B7H0KJ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const localVideo = document.getElementById('cam1');
  const remoteVideo = document.getElementById('cam2');
  const consentDiv = document.getElementById('consentDiv');
  const consentText = document.getElementById('consentText');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const endBtn = document.getElementById('endCall');

  let localStream;
  let peer;
  let role = null; // host or joiner
  let firebaseListenerAttached = false;

  // Firebase paths
  const requestsRef = db.ref('privateCall/joinRequests');
  const signalRef = db.ref('privateCall/signal');

  // ===== Helpers =====
  async function startLocalStream() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
  }

  function cleanup() {
    if(peer) peer.destroy();
    if(localStream) localStream.getTracks().forEach(t => t.stop());
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    db.ref('privateCall').remove();
    peer = null;
    firebaseListenerAttached = false;
  }

  // ===== Host logic =====
  document.getElementById('hostCall').onclick = async () => {
    role = "host";
    await startLocalStream();

    // Listen for join requests
    requestsRef.on('value', snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const joinerId = Object.keys(data)[0]; // handle one request at a time
      consentText.textContent = "Someone wants to join your call. Do you consent?";
      consentDiv.style.display = "block";

      yesBtn.onclick = () => {
        db.ref(`privateCall/joinRequests/${joinerId}/consent`).set("yes");
        consentDiv.style.display = "none";
        startPeer(true); // Host initiates SimplePeer
      };

      noBtn.onclick = () => {
        db.ref(`privateCall/joinRequests/${joinerId}/consent`).set("no");
        consentDiv.style.display = "none";
      };
    });
  };

  // ===== Joiner logic =====
  document.getElementById('joinCall').onclick = async () => {
    role = "joiner";
    await startLocalStream();

    const myReqRef = requestsRef.push();
    myReqRef.set({ consent: "pending" });

    myReqRef.on('value', snapshot => {
      const data = snapshot.val();
      if(!data) return;
      if(data.consent === "no") {
        alert("Host denied your request.");
      }
      if(data.consent === "yes") {
        // Only start peer after consent is yes
        if(!peer) startPeer(false);
      }
    });
  };

  // ===== SimplePeer setup =====
  function startPeer(initiator) {
    peer = new SimplePeer({ initiator, stream: localStream, trickle: true });

    peer.on('signal', data => {
      const key = signalRef.push();
      key.set({ role, data });
    });

    peer.on('stream', stream => {
      remoteVideo.srcObject = stream;
    });

    // Attach Firebase listener only once
    if(!firebaseListenerAttached) {
      signalRef.on('value', snapshot => {
        const signals = snapshot.val();
        if(!signals || !peer) return;
        Object.values(signals).forEach(s => {
          if(s.role !== role) peer.signal(s.data);
        });
      });
      firebaseListenerAttached = true;
    }
  }

  // ===== End Call =====
  endBtn.onclick = () => {
    cleanup();
    alert('Call ended');
  };
</script>
</body>
</html>
